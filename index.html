
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Introduction Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.2">
        
        
        
    
    <link rel="stylesheet" href="gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="recipes.html" />
    
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter active" data-level="1.1" data-path="./">
            
                <a href="./">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="recipes.html">
            
                <a href="recipes.html">
            
                    
                    Recipes
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="recipes.html">
            
                <a href="recipes.html#network-request">
            
                    
                    Network Request
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="recipes.html">
            
                <a href="recipes.html#reading-large-file">
            
                    
                    Reading Large File
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="reference.html">
            
                <a href="reference.html">
            
                    
                    API Reference
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="reference.html">
            
                <a href="reference.html#cancellablepromise">
            
                    
                    CancellablePromise
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="reference.html">
            
                <a href="reference.html#cancellable">
            
                    
                    cancellable
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="reference.html">
            
                <a href="reference.html#interruptible">
            
                    
                    interruptible
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="reference.html">
            
                <a href="reference.html#coroutine">
            
                    
                    coroutine
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5" data-path="reference.html">
            
                <a href="reference.html#compose">
            
                    
                    compose
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.6" data-path="reference.html">
            
                <a href="reference.html#decompose">
            
                    
                    decompose
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="." >Introduction</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="no-thanks">No Thanks!</h1>
<h3 id="fine-grained-cancellation-for-promises">Fine-grained cancellation for promises</h3>
<p>The <strong>no-thanks</strong> package provides a set of <strong>utilities to cancel a promise</strong> that can be used as <strong>primitives</strong> to compose more complex pipelines with the ability to stop execution at any time</p>
<p><code>npm i --save no-thanks</code></p>
<p>20 kB source, 5.8 kB minified, <strong>1.8 kB</strong> gzipped</p>
<p>Quick links:</p>
<ul>
<li><a href="https://github.com/vacavaca/no-thanks" target="_blank">Source Code</a></li>
<li><a href="reference.html">API Reference</a></li>
<li><a href="https://github.com/vacavaca/no-thanks/releases" target="_blank">Release Notes</a></li>
</ul>
<p>In case the website is down all the documentation can be found in the <a href="https://github.com/vacavaca/no-thanks/tree/master/doc" target="_blank">doc directory</a> of the source repository </p>
<h2 id="motivation">Motivation</h2>
<p>It&apos;s a very common situation when a javascript program has to run some expensive or long-running task and then the result of the task or the task itself is no longer needed. </p>
<p>As an example, an application may start a <strong>network request</strong> (or a group of requests) and then the user clicks &quot;Cancel&quot; button or changes some parameters so we need to abort the request and drop the result.</p>
<p>Standard javascript APIs such as <strong>Promise</strong> or <strong>AsyncFunction</strong> has no way to stop a task, neither has a tool to <strong>split the task into smaller ones</strong> and stop them in a more 
<em>granular</em> way.</p>
<p>This library provides such tools, along with a cancellation callbacks to free up resources after cancel.</p>
<h2 id="getting-started">Getting Started</h2>
<pre><code class="lang-js"><span class="hljs-keyword">const</span> {
    CancellablePromise, 
    cancellable, 
    interruptible, 
    coroutine, 
    compose, 
    decompose } = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;no-thanks&apos;</span>)
</code></pre>
<p>If the package is included in a browser with <code>&lt;script&gt;</code> tag, it can be found at <code>window.noThanks</code> key</p>
<h3 id="basic-usage">Basic Usage</h3>
<p><code>CancellablePromise</code> is a <code>Promise</code> that can be canceled. It extends native <code>Promise</code> for full compatibility</p>
<blockquote>
<p><em>class</em> <strong>CancellablePromise</strong> <em>(<strong>task</strong>: Function|Promise, <strong>finalizer</strong>: ?Function = null)</em> extends <em>Promise</em></p>
</blockquote>
<p>The very basic usage of it:</p>
<pre><code class="lang-js"><span class="hljs-keyword">let</span> job = <span class="hljs-keyword">new</span> CancellablePromise(someTask);

<span class="hljs-comment">// or alternativelly:</span>
job = cancellable(someTask);

<span class="hljs-comment">/* ... */</span>

job.cancel()
</code></pre>
<p>When the <code>cancel</code> method is called while the <code>someTask</code> is not finished, fulfillment value or the rejection of it will be muted and will not be propagated further.</p>
<p>If <code>someTask</code> has finished execution before the <code>cancel</code> method was called, the cancellation has no effect, but the finalizer (if given) will be called anyway. </p>
<p><strong>Note</strong> <code>CancellablePromise</code> constructor and <code>cancellable</code> function are interchangeable except the <em>fineGrained</em> parameter that will be discussed a bit later</p>
<h3 id="finalization">Finalization</h3>
<p><code>CancellablePromise</code> constructor or <code>cancellable</code> function can be called with a callback that will be called after cancel.</p>
<p>This callback is responsible for a finalization of the task, it&apos;s often used to do some cleanup when a task was canceled.</p>
<p>The finalizer will be called with the results of promises that are already fulfilled at the time of cancel</p>
<pre><code class="lang-js"><span class="hljs-comment">// CancellablePromise constructor can also be used here</span>
<span class="hljs-keyword">const</span> job = cancellable(someTask, taskResult =&gt; { 
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;finalization&apos;</span>)
})

<span class="hljs-comment">/* ... */</span>

job.cancel()

<span class="hljs-comment">// outputs:</span>
<span class="hljs-comment">// &gt; finalization</span>
</code></pre>
<p>Because <strong>finalizer is called asynchronously</strong> <code>cancel</code> method of the <code>CancellablePromise</code> returns a <code>Promise</code> with the result of finalizer call. If the finalizer returns promise it will be automatically chained into a cancellation result promise</p>
<pre><code class="lang-js"><span class="hljs-keyword">const</span> job = cancellable(someTask, () =&gt; <span class="hljs-built_in">Promise</span>.resolve(<span class="hljs-number">42</span>))

job.cancel()
    .then(answer =&gt; <span class="hljs-built_in">console</span>.log(answer))

<span class="hljs-comment">// prints: 42</span>
</code></pre>
<p><strong>Note</strong> that the finalizer will be called after <code>cancel()</code> in any case, even if the wrapped promise was successfully fulfilled with a value or rejected</p>
<h3 id="fine-grained-cancellation">Fine-grained cancellation</h3>
<p>To create a cancellable pipeline of promises just call <code>.then</code> and <code>.catch</code> methods of <code>CancellablePromise</code>, then the resulting promise can be canceled in the middle of execution </p>
<pre><code class="lang-js"><span class="hljs-comment">// CancellablePromise constructor can also be used here</span>
<span class="hljs-keyword">const</span> job = cancellable(task1, (result1, resul2, result3) =&gt; {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;canceled&apos;</span>, result1, result2, result3)
    })
    .then(() =&gt; task2)
    .then(() =&gt; task3)

<span class="hljs-comment">/* ... wait for task1 to complete and task2 to start */</span>

job.cancel()

<span class="hljs-comment">// outputs:</span>
<span class="hljs-comment">// &gt; canceled resul1 result2 undefined</span>
</code></pre>
<p>Note that only first two tasks were executed</p>
<h3 id="async-function">Async Function</h3>
<p>The cancellation of an <code>AsyncFunction</code> is controlled with special argument &quot;<strong>fineGrained</strong>&quot;: <code>boolean</code> in the <code>cancellable</code> signature:</p>
<blockquote>
<p><strong>cancellable</strong> <em>(<strong>task</strong>: AsyncFunction|Promise, <strong>finalizer</strong>: ?Function = null, <strong>fineGrained</strong>: boolean = true)</em> =&gt; <code>CancellablePromise</code></p>
</blockquote>
<p>When it&apos;s set to true (default) additional argument will be given to the task function, this argument is used to wrap inner tasks into <em>&quot;grains&quot;</em> to make them cancellable. The argument will be provided at the first position and it&apos;s usually named &quot;grain&quot;</p>
<pre><code class="lang-js"><span class="hljs-keyword">const</span> job = cancellable(<span class="hljs-keyword">async</span> (grain, ...args) =&gt; {
    <span class="hljs-keyword">await</span> grain(task1)
    <span class="hljs-comment">/* do other stuff */</span>
    <span class="hljs-keyword">await</span> grain(task2)
    <span class="hljs-keyword">await</span> grain(<span class="hljs-number">42</span>) <span class="hljs-comment">// any value can be wrapped into grain, and passed to the finalizer</span>
    <span class="hljs-keyword">await</span> grain(task3)

    <span class="hljs-built_in">console</span>.log(...agrs)
    <span class="hljs-comment">/// prints: the answer is 42</span>
})

<span class="hljs-comment">// run the job</span>
<span class="hljs-keyword">const</span> running = job(<span class="hljs-string">&apos;the&apos;</span>, <span class="hljs-string">&apos;answer&apos;</span>, <span class="hljs-string">&apos;is&apos;</span>, <span class="hljs-number">42</span>)

<span class="hljs-comment">/* ... */</span>

running.cancel()
</code></pre>
<h3 id="coroutine">Coroutine</h3>
<p>To avoid unnecessary verbosity with a <strong>grain</strong> argument from the previous example, a generator can be used instead of <code>AsyncFunction</code>. The library provides the <strong>coroutine</strong> method for that. It takes a generator function as an argument and wraps it into a <code>CancellablePromise</code>.</p>
<p>This approach &#x441;ould be used to run a set of independent tasks sequentially, but if the next task in pipeline somehow depends on the result of the previous one, then <code>cancellable</code> method should be used. </p>
<blockquote>
<p><strong>coroutine</strong> <em>(<strong>generator</strong>: Generator Function, <strong>finalizer</strong>: ?Function = null, <strong>fineGrained</strong>: boolean = true)</em> =&gt; <code>CancellablePromise</code></p>
</blockquote>
<p>Optionally it takes <strong>finalizer</strong> as the second argument, and <strong>fineGrained</strong> as the third, if the <strong>fineGrained</strong> is set to true (default) then all the <code>Promise</code>s that generator yields will be wrapped into <em>grains</em>, like in the previous example:</p>
<pre><code class="lang-js"><span class="hljs-keyword">const</span> job = coroutine(<span class="hljs-function"><span class="hljs-keyword">function</span>* (<span class="hljs-params">...args</span>) </span>{
    <span class="hljs-keyword">yield</span> task1
    <span class="hljs-comment">/* do other stuff */</span>
    <span class="hljs-keyword">yield</span> task2
    <span class="hljs-keyword">yield</span> task3

    <span class="hljs-built_in">console</span>.log(...args)
    <span class="hljs-comment">// prints: the answer is 42</span>
})

<span class="hljs-keyword">const</span> running = job(<span class="hljs-string">&apos;the&apos;</span>, <span class="hljs-string">&apos;answer&apos;</span>, <span class="hljs-string">&apos;is&apos;</span>, <span class="hljs-number">42</span>)

<span class="hljs-comment">/* ... */</span>

running.cancel()
</code></pre>
<h3 id="interruptible">Interruptible</h3>
<p>All the functions described above cancel a task and run finalizer only after the currently executing task is fulfilled or rejected, but sometimes it&apos;s necessary to <strong>interrupt a task immediately</strong> for example, when a network request was canceled by the user it should be aborted before the response arrives.</p>
<p>For that reason the <strong>interruptible</strong> method can be used:</p>
<blockquote>
<p><strong>interruptible</strong> <em>(<strong>task</strong>: AsyncFunction|Promise, <strong>finalizer</strong>: ?Function = null, <strong>fineGrained</strong>: boolean = true)</em> =&gt; <code>CancellablePromise</code></p>
</blockquote>
<pre><code class="lang-js"><span class="hljs-keyword">const</span> job = interruptible(<span class="hljs-keyword">async</span> (grain, ...args) =&gt; {
    <span class="hljs-keyword">await</span> grain(task1)
    <span class="hljs-keyword">await</span> grain(task2)
    <span class="hljs-keyword">await</span> grain(task3)

    <span class="hljs-built_in">console</span>.log(...agrs)
    <span class="hljs-comment">/// prints: the answer is 42</span>
})

<span class="hljs-comment">// run the job</span>
<span class="hljs-keyword">const</span> running = job(<span class="hljs-string">&apos;the&apos;</span>, <span class="hljs-string">&apos;answer&apos;</span>, <span class="hljs-string">&apos;is&apos;</span>, <span class="hljs-number">42</span>)

<span class="hljs-comment">/* ... */</span>

running.cancel()
</code></pre>
<p>The interface of this method is identical to the <a href="reference.html#cancellable">cancellable</a> method, except it runs finalize immediatelly after <code>cancel()</code></p>
<p><strong>Note</strong> Use <strong>interruptible</strong> with care and only if your tasks (<em>grains</em>) support immediate abortion, in other case the state of the current task will be unpredictable.</p>
<p>Check <a href="recipes.html#network-request">network request</a> recipe for more real-life example</p>
<h3 id="compose--decompose">Compose &amp; Decompose</h3>
<p>There are two more utility functions in the public API</p>
<p><strong>compose</strong> <em>(<strong>promise</strong>: Promise|Object)</em> =&gt; <code>Promise</code></p>
<p>and</p>
<p><strong>decompose</strong> <em>(<strong>promise</strong>: Object)</em> =&gt; <code>Promise</code></p>
<p>They are used to avoid automatic chaining when returning <code>Promise</code>s from promise resolvers and async functions.</p>
<pre><code class="lang-js">
(<span class="hljs-keyword">async</span> () =&gt; compose(<span class="hljs-built_in">Promise</span>.resolve(<span class="hljs-number">42</span>)))()
    .then(decompose)
    .then(value =&gt; value === <span class="hljs-number">42</span>)
</code></pre>
<hr>
<p>More examples and recipes can be found <a href="recipes.html">here</a></p>
<p>Also, take a look at the <a href="https://github.com/vacavaca/no-thanks/tree/master/test" target="_blank">test directory</a>, it contains <strong>a lot</strong> of examples of different semantics of the library methods</p>
<h1 id="license">License</h1>
<p>MIT</p>
<p>See <a href="https://github.com/vacavaca/no-thanks/blob/master/LICENSE" target="_blank">LICENSE</a> to see the full text.</p>
<hr>
<p>All notable changes are documented in the <a href="https://github.com/vacavaca/no-thanks/blob/master/CHANGELOG.md" target="_blank">CHANGELOG.md</a> file.</p>
<p>This package can also be found at:</p>
<ul>
<li><a href="https://www.npmjs.com/package/no-thanks" target="_blank">npm</a></li>
</ul>
<h1 id="about-the-author">About the Author</h1>
<p>I&apos;m a web-developer, based in ~700 km south of the Arctic Circle in the beautiful city of Saint-Petersburg.</p>
<p>Feel free to contact me by <a href="mailto:vacavaca@fastmail.com" target="_blank">email</a></p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                
                <a href="recipes.html" class="navigation navigation-next navigation-unique" aria-label="Next page: Recipes">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Introduction","level":"1.1","depth":1,"next":{"title":"Recipes","level":"1.2","depth":1,"path":"recipes.md","ref":"recipes.md","articles":[{"title":"Network Request","level":"1.2.1","depth":2,"anchor":"#network-request","path":"recipes.md","ref":"recipes.md#network-request","articles":[]},{"title":"Reading Large File","level":"1.2.2","depth":2,"anchor":"#reading-large-file","path":"recipes.md","ref":"recipes.md#reading-large-file","articles":[]}]},"dir":"ltr"},"config":{"plugins":["-sharing"],"root":"doc/","styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"intro.md","glossary":"GLOSSARY.md","summary":"summary.md"},"variables":{},"gitbook":"3.2.2"},"file":{"path":"intro.md","mtime":"2018-05-31T13:25:46.736Z","type":"markdown"},"gitbook":{"version":"3.2.2","time":"2018-05-31T13:26:01.324Z"},"basePath":".","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="gitbook/gitbook.js"></script>
    <script src="gitbook/theme.js"></script>
    
        
        <script src="gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

